stages:
  - install
  - build
  - docker

variables:
  DOCKER_IMAGE: "$CI_REGISTRY_IMAGE/angular-frontend"
  NODE_VERSION: "20"  # Node.js version to use

# Use Node.js image for install and build
image: node:$NODE_VERSION

# Stage 1: Install dependencies
install-dependencies:
  stage: install
  script:
    # Use npm install in case package-lock.json is missing
    - npm install
  only:
    - dev

# Stage 2: Build Angular application
build-frontend:
  stage: build
  script:
    - npm run build --prod  # Build production files in dist/
  artifacts:
    paths:
      - dist/
  only:
    - dev

# Stage 3: Build and push Docker image
docker-build-push:
  stage: docker
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    # Login to GitLab Container Registry
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    # Build Docker image using Dockerfile
    - docker build -t $DOCKER_IMAGE:latest .
    # Tag image with commit SHA
    - docker tag $DOCKER_IMAGE:latest $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
    # Push both tags to GitLab Container Registry
    - docker push $DOCKER_IMAGE:latest
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
  only:
    - dev
